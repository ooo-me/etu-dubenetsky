МИНОБРНАУКИ РОССИИ
САНКТ-ПЕТЕРБУРГСКИЙ ГОСУДАРСТВЕННЫЙ
ЭЛЕКТРОТЕХНИЧЕСКИЙ УНИВЕРСИТЕТ 
«ЛЭТИ» ИМ. В.И. УЛЬЯНОВА (ЛЕНИНА)
Кафедра Информационных систем



ДОМАШНЯЯ РАБОТА
по дисциплине «Современные методы и средства проектирования информационных систем»
Тема: Задание 4.1. Приемы моделирования правил и ограничений на примере работы с тарифами на услуги














Студенты:
Группа	ФИО	Подпись исп.	Оценка	Подпись  преп.
				
				
				

Преподаватель		Дубенецкий В.А.


Санкт-Петербург
2025
ЗАДАНИЕ
НА РАБОТУ 
Тема : Задача 4.1. Приемы моделирования правил и ограничений на примере работы с тарифами на услуги

Требования
1.1. Разработать проект каркаса для работы с тарифами на услуги 
 Обеспечить:
	Ведение справочника услуг различных типов с указанием параметров для расчета стоимости;
	Ведение справочника тарифов на услуги;
	Формирование заказов на услуги с указанием значений параметров заказываемых услуг; 
	Описание правил и ограничений, позволяющих рассчитать стоимость заказываемых услуг;
	Расчет стоимости заказа на услуги по тарифу;
	Поиск оптимального по стоимости исполнителя заказа на услуги.

1.2. Содержание работы
№	Этап выполнения	Результат
1.		Разработать функциональные требования к проектируемой подсистеме	Диаграммы вариантов использования. Описание компонентов диаграмм
2.		Разработать модель классов для выделенных процессов	Диаграммы классов с операциями и атрибутами. Описание компонентов диаграмм.
3.		Разработать модель хранения в среде  СУБД  данных о тарифах, правилах	Диаграммы ER. Скрипты метаданных с комментариями.
4.		Разработка основных SQL-процедур для работы с конструктором тарифов, заказами на услуги и расчетом стоимости услуг по заказам	Скрипты SQL-процедур с комментариями.
5.		Тестирование процедур	Описание тестов. Скрипты исходных данных для тестов.
Скриншоты результатов тестирования. 

1.3. Исходные данные для задачи
№ вар.	Наименование тарифа	Источник
1.		ТАРИФЫ НА ГРУЗОПЕРЕВОЗКИ ПО ГОРОДУ	Файл ТАРИФЫ НА ГРУЗОПЕРЕВОЗКИ ПО ГОРОДУ.docx
2.		Расчет месячного бюджета ответственного хранения
	Файл  ТАРИФЫ НА ГРУЗОПЕРЕВОЗКИ ПО ГОРОДУ.docx
Список дополнительных тарифов согласовать с преподавателем.
Рекомендуемые инструменты:
1.	Редактор StarUML
2.	Редактор Visio. Модель Database.Entity relationship
3.	DB-редактор IBExpert
4.	СУБД  Firebird 2.5.3.
5.	Текстовый редактор Notepad
6.	Текстовый редактор Word

Рекомендуемые источники:
1. Data Definition Guide : файл DataDef.pdf
2. Language Reference Guide: файл   LangRef.pdf
3. Архитектура информационных систем. Учебник. М.,Издательский центр «Академия», 2012
4. Приемы объектно-ориентированного проектирования. Паттерны проектирования: Изд-во «ПИТЕР», 2008
5. Проектирование корпоративных информационных систем.: СПб, Изд-во СПбГЭТУ «ЛЭТИ», 2013
6.Джеймс Рамбо, Айвар Якобсон, Грэди Буч  UML: специальный справочник. – СПб: Питер, 2002.
7.Дубенецкий В.А., Кузнецов А.Г., Цехановский В.В. Технология создания корпоративных информационно-управляющих систем на основе моделей, допускающих исполнение. СПб: Изд-во СПбГЭТУ «ЛЭТИ», 2019. 158 с.
8.В.А. Дубенецкий Проектирование информационно-управляющих 
систем на основе моделей, допускающих исполнение. СПбГЭТУ «ЛЭТИ 2020. 114 с.

Содержание пояснительной записки:
«Введение», «Анализ предметной обрасти», «Разработка объектной модели этапа проектирования», «Разработка модели хранения», «Разработка основных процедур», поддерживающих работы с материальными спецификациями изделий, «Результаты тестирования», «Заключение», «Список использованных источников»)

Предполагаемый объем пояснительной записки:
Не менее 20 страниц.
Дата выдачи задания: 
Дата сдачи отчета: 
Дата защиты работы: 
Студенты:
Группа	ФИО	Подпись исп.
		
		
		


Преподаватель                             _____________________   (Дубенецкий В.А
 
АННОТАЦИЯ
Предлагаются решения по использованию моделей правил и ограничений для решения задач управления тарифами на услуги и заказами на услуги. Разработан проект каркаса, позволяющий формировать классификатор услуг и описывать тарифы на их выполнение со сложной логикой выбора условий применения услуг. Модель услуги используется для формирования заказов на услуги и расчета стоимости заказа. Шаблоны услуг описываются на периоде исполнения. 
SUMMARY
Solutions are proposed for using models of rules and restrictions to solve problems of managing tariffs for services and orders for services. A draft framework has been developed that allows forming a classifier of services and describing tariffs for their implementation with a complex logic of choosing the conditions for using services. The service model is used to generate orders for services and calculate the cost of the order. Service templates are described on the execution period. 
Содержание
1. Анализ исходных данных.	8
3. Разработка проектной модели классов	12
4. Разработка модели хранения	29
5. Разработка процедур поддержки работы с правилами и ограничениями	31
6. Подготовка примеров работы с правилами и ограничениями	31
7. Тестирование процедур конструктора и исполнителя расчетов на основе использования правил	36
Выводы	36

 

1. Анализ исходных данных. 
В качестве исходных данных используется описание примеров нескольких бланков для описания тарифов для расчета стоимости услуг.
     Для примера рассмотрим задачу работы с тарифами на грузоперевозки.
Тарифы на перевозку. Для примера на рис. 1 представлен фрагмент описания тарифов на перевозку грузов. 


Грузо-
подъемность, объем	Тариф 8 часов, руб.	Тариф 4 часа, руб.	Стоимость часа на тарифе 8, руб.	Стоимость часа на тарифе 4, руб.	Стоимость километра перепробега по городу, руб./км.	Стоимость километра перепробега по области, межгороду, руб./км.
Закрытые автомобили
0,5 т.	3160	1900	395	420	14	16
1 т.	3480	2120	435	470	15	17
1,5 т. до 10м3 до 4 паллет	3960	2220	495	495	16	18
Рис. 1. Фрагмент таблицы с тарифами на грузоперевозки
Построим объектную модель этапа анализа для работы с тарифами на грузоперевозку. Модель должна поддержать расчет стоимости грузоперевозки при заданных параметрах груза. Из представленного фрагмента видно, что стоимость грузоперевозки зависит от следующих параметров:
•	Грузоподъемность, объем;
•	Временной интервал (4 часа, 8 часов);
•	Вариант маршрута (по городу, по области, межгород);
•	Вариант грузового авто. 
Стоимость задается в виде следующих параметров:
•	Стоимость часа на тарифе 4 часа;
•	Стоимость часа на тарифе 8 часов;
•	Стоимость километра перепробега по городу (руб./км);
•	Стоимость километра перепробега по области, межгороду (руб./км);
•	Тариф 8 часов (руб);
•	Тариф 4 часа (руб).
Параметр Грузоподъемность, объем представляет собой ограничение весовых и объемных характеристик груза и разделяется на три составляющие: Вес (т);Объем (м3); Количество паллет (шт). На рис. 2 представлена модель классов, которая соответствует фрагменту таблицы тарифов, представленной на рис. 1.

 
Рис. 2. Диаграмма классов для примера Грузоперевозки
В модели учтены следующие расширения:
•	каждая транспортная фирма может иметь несколько тарифов и задавать свои значения стоимостных показателей;
•	список классов авто открыт и может дополняться.
Классы-сущности Фирма, Тариф_перевозки и роль Тарифы фирмы обеспечивает ведение тарифов для различных фирм.  Содержание тарифа описывается  с помощью класса Позиция_тарифа и роли Состав_тарифа. Для класса Позиция_тарифа объявлены атрибуты  Вес_от, Вес_до, Ограничение_паллет_от, Ограничение_паллет_до, Объем_от, Объем_до, Стоимость_часа, Временной_интервал_от, Временной_интервал_до. Для учета класса авто в позициях тарифа введены метакласс Классификатор_авто, роль Класс_авто_для_позиции. Для учета влияния варианта местности в расценках на перепробег введены перечисление Вариант_местности, класс Перепробег, роль Вариант_местности_для_перепробега и роль Расценки_перепробега. Такие свойства тарифа как Тариф 8 часов (руб), Тариф 4 часа (руб) могут быть вычислены на основе представленных в модели классов компонентов. Для того, чтобы проверить корректность построенной модели классов на ее основе можно построить диаграмму потоков данных.  Схема потоков данных для примера представлена на рис. 3. Диаграмма построена с представлением функций доступа и вычислительный функций. Используя эту диаграмму можно показать, что модель, представленная на рис. 6.4, позволяет работать с тарифами на грузоперевозки в соответствии с фрагментом исходных данных, представленном на рис. 6.1.
 
Рис. 3. Диаграмма потоков данных для примера Грузоперевозки
Нет проблем сформировать на основе модели классов  ERD и скрипты базы данных ОРМ. Кроме того, модель потоков данных (рис. 3) позволяет разработать набор SQL-процедур, обеспечивающий необходимые сервисы ведения тарифов на грузоперевозки и поиска фирм и позиций наилучшим образом удовлетворяющих характеристикам груза. Однако любые изменения в метаданных модели тарифов потребуют изменить структуру базы данных, модифицировать и расширить набор поддерживающих SQL-процедур. Некоторые принятые обозначения и правила описания функций доступа представлены ниже.
Классы и метаклассы:
•	 Классы-сущности = {Груз, Фирма, Тариф}. 
•	 Классификаторы = {Классификатор_грузов, Класификатор_фирм, 
      Классификатор_авто}.
•	 Зависимые классы ={Позиция_тарифа}.
Переменные:
•	 g  Груз       - переменная “g”   типа “Груз”, можно отождествлять с идентификатором элемента из “Груз”;
•	p  Позиция_тарифа.

3. Разработка проектной модели классов 
Квалификатор – qualifier. Для конкретного объекта исходного класса значение квалификатора позволяет выбрать объект или подмножество объектов целевого класса. Квалификатор представляет собой предикативную функцию, определенную на значениях свойств элемента исходного класса и элемента целевого класса. Квалификатор относится к заданной роли с вариантом множественности 0..n соответствующей ассоциации. 
Пример квалификатора для роли Позиции_тарифа_для_груза:
(Вес_от(p) <=Вес_груза(g))
and (Вес_до(p) < Вес_груза(g))
and (Объем от(p)<=Объем_груза(g))
and (Объем_до(p) > Объем_груза(g))
and (Ограничение_паллет_от(p)<= Количество_паллет(g))
and (Ограничение_паллет_до(p)> Количество_паллет(g))
and (Временной_интервал_от(p)<= Ожидаемое_время(g))
and (Временной_интервал до(p)> Ожидаемое_время(g))
and (Класс_грузового_авто_для_позиции(p) <= Требуемый_класс_авто(g))
Из приведенного примеры видно, что в выражении для квалификатора присутствуют как атрибуты элементов p и q, так и роли, зависящие от них:
Вес_от(p) <=Вес_груза(q)             /* использование атрибутов в предикате*/
Класс_грузового_авто_для_позиции(p) <= Требуемый_класс_авто(q)   /* использование ролей в предикате*/.
      В общем случае в предикатах могут использоваться разнообразные функции доступа с вариантом множественности 0..1, определенные для целевого и исходного элементов. Для функций доступа с вариантом 0..n  могут использоваться кванторы , , стандартные функции Min(), Max(), count().
Разработка модели этапа проектирования для ведения тарифов на услуги. Трудно представить все разнообразие моделей ведения тарифов даже в рамках грузоперевозок. Если задачу разработки проектной модели поставить шире как ведение тарифов на услуги, то разнообразие моделей станет еще больше. Рассмотрим “узкие места” модели, представленной на рис. 2, и выделим точки расширения и абстрагирования этой модели. Данная модель ориентирована на такой вариант услуги как Грузоперевозки. Введем метакласс Классификатор_услуг и ассоциацию с ролью Услуга_по_тарифу. Это расширение позволит вести классификатор услуг и создавать тарифы по выбранному классу услуг. Следующее узкое место в исходной модели связано с ограничением на состав параметров класса Позиция_тарифа. Этот состав определен в метаданных и рассчитан только на параметры конкретной структуры тарифа на грузоперевозки, хотя и описан в метаданных класса Позиция_тарифа. Следующий шаг расширения – введение специального метакласса Параметр. Этот метакласс позволит описывать и вести глобальный список параметров и ссылаться на него при описании введенных классов услуг.  Ассоциативный класс Параметр_услуги, ассоциации с ролями Параметр_для_услуги и Состав_параметров поддержат сервисы описания характеристик классов услуг.  Квалификатор для отбора позиций тарифа по параметрам груза  представляет собой конъюнкцию предикатов, определенных на параметрах класса Позиция_тарифа и параметрах класса Груз. Область значений параметров определяется через роль Тип_параметра.  Расширенная модель метаклассов для примера представлена на рис. 4. Для вещественных параметров требуется дополнительно ввести ряд ограничений. На рис. 5 представлен фрагмент модели метаклассов, позволяющий уточнить спецификацию вещественных параметров для услуги.

 
Рис.4. Пример расширенной модели для работы с тарифами на услуги
Для описания вещественных параметров вводится класс Единица_измерения и ассоциация с ролью ЕИ_для_параметра.  Кроме того, для ассоциативного метакласса Параметр_услуги, если он вещественного типа, вводятся атрибуты Мин, Макс, позволяющие задать ограничения на значения параметра в описании тарифов на эту услугу.
 
Рис. 5. Фрагмент модели метаклассов для описания вещественных параметров
Для параметров типа Перечисление фрагмент модели метаклассов представлен на рис. 6.
 
Рис. 6. Фрагмент модели метаклассов для описания параметров типа Перечисление
Метакласс Перечисление, позволяет создать необходимые перечисления. Класс Позиция_перечисления и ассоциация с ролью Список_значений позволяют описать область значений для конкретных перечислений и соответствующих параметров. 
Расширенная модель метаклассов для описания параметров типа Классификатор_объектов представлена на рис. 7. Отметим введение в модель метакласса Классификатор_объектов, позволяющий описывать тип параметра через класс предметной области.
 
Рис. 7. Расширенная модель для описания типов параметров
Модель метаклассов, представленная на рис. 4, обладает существенно более высоким уровнем абстрагирования, по сравнению с исходной моделью этапа анализа (рис. 2). Новый вариант модели позволяет создать конструктор, описывающий структуру различных классов услуг и на основе этих шаблонов создавать конкретные тарифы, описывать параметры конкретных услуг и решать задачи поиска подходящих тарифов для этих услуг. Переход от модели, представленной на рис. 4, к модели ERD, используя приемы ОРМ, не должен вызывать затруднений. Как и ранее, требуется разработать комплекс SQL-процедур, поддерживающих необходимые сервисы работы с тарифами. Набор сервисов расширился. Появились сервисы конструирования  структур тарифов, доступные на периоде исполнения.  Но процедурная поддержка не зависит от конкретных структур тарифов. Разработанная модель допускает исполнение и предоставляет своеобразный язык для описания тарифов и работы с ними. Однако остались еще “узкие места” в представленной модели. 
Использование объектной модели правил. Существенным ограничением является то, что позиция тарифа описывается в виде конъюнкции предикатов, определенных на параметрах класса услуги. В более общем случае для описания позиций тарифов можно применить механизм продукций.  Использование модели правил позволяет существенно улучшить свойства проектной модели и снять ряд ограничений при описании работы с нормативными данными. На рис. 8 представлен фрагмент модели метаклассов, в котором использована модель правил. Класс Правило позволяет работать с правилами, определенными на компонентах модели тарифов. В свою очередь, условие описывается в виде сокращенной дизъюнктивной нормальной формы. Для этого в модель введены классы Конъюнкция, Предикат и ассоциации с ролями ИЛИ и И.
  Рис. 8. Модель метаклассов для управления тарифами на услуги с использованием правил
Каждое решение представляется в виде значения для соответствующего параметра. Для рассматриваемого примера в решении указано значение соответствующей расценки по тарифу в соответствии с правилом. 
Чтобы поддержать большое разнообразие классов услуг и их структур в модель введен конструктор шаблонов услуг. Метакласс Классификатор_услуг позволяет создавать новые классы услуг. Состав параметров для каждого класса описывается с помощью ассоциативного класса Параметр_услуги и ассоциаций с ролями Состав_параметров_услуги, Параметр_для услуги. Для описания структуры тарифов введены метаклассы Шаблон_тарифа, Шаблон_правила и ассоциация с ролью Состав_шаблонов_правил. Для описания предикатов введены  метакласс Шаблон_предиката, Предикат_шаблона_условия и ассоциация с ролью Состав_шаблонов_предикатов. Ассоциация с ролью По_шаблону_тарифа позволяет создавать тарифы в соответствии с выбранным шаблоном. Ассоциация с ролью По_шаблону_правила позволяет описывать правила тарифа в соответствии с указанным шаблоном.
 
Рис.  9. Пример документа для описания тарифов на услугу ответственного хранения
Модель анализа, построенная на основе первого документа (рис. 1) представлена на рис. 2. Показано, что эта модель позволяет полностью отразить особенности данных исходного документа.
 Модель этапа анализа, построенная для второго документа (рис. 9), представлена на рис. 10. 
 
Рис. 10. Модель классов этапа анализа для работы с тарифами на ответственное хранение
Класс Тариф_на_услуги_отв_хранения и ассоциация с ролью Тарифы_отв_хранения позволяют различным фирмам создавать различные варианты тарифов на ответственное хранение продукции, отличающиеся значениями параметров позиций тарифа. Класс Позиция_тарифа_на_услуги позволяет задать месячный бюджет услуги на основе значения атрибута Средний_объем_паллет_в_день и значений ролей Для_модели_паллет и Оборачиваемость. Перечисление Вариант_оборачиваемости задает область значений роли Оборачиваемость. Аналогично, перечисление Модель_паллеты позволяет описать модели паллет и задать вариант паллеты в описании позиции тарифа. Класс Запрос_на_ответственное_хранение позволяет формировать запросы на ответственное хранение продукции с указанием значений необходимых характеристик для выбора позиций тарифа и расчета стоимости услуги.
    Проверка корректности проектной модели. Рассмотрим, сможет ли обобщенная модель, представленная на рис. 8, поддержать все возможности рассматриваемых моделей этапа анализа (рис. 2 и 10). Для проверки корректности покажем, что построенная модель позволит описать данные документов, представленных на рис. 1 и 9. Из первого документа выберем для проверки данные третьей строки. Из второго документа выберем заголовок и 4, 5 и 6 строки.  Проверку будем производить в следующей последовательности. На основе каждого из рассматриваемых документов необходимо построить модель класса этапа анализа и проверить их корректность на наличие необходимых классов и ассоциаций, а также некоторых правил работы с данными. Для каждой из построенных моделей проверяем возможность ее представления в итоговой модели.
    Для описания модели, представленной на рис. 10, необходимо включить в классификатор услуг класс Услуга_ответственного_хранения. Далее требуется расширить список требуемых параметров. Метакласс Параметр позволяет описать необходимые параметры: Средний_объем_хранения_в_день, Месячный_бюджет, Оборачиваемость, Для_модели_паллет. Для параметра Оборачиваемость: Вариант_оборачиваемости необходимо используя метакласс Перечисление объявить  перечисление Вариант_оборачиваемости. На рис. 6 приведена диаграмма классов, описывающая решение для работы с параметрами типа перечисление. Аналогично для параметра Для_модели_паллет необходимо объявить перечисление Модели_паллет. Используя ассоциации с ролями Состав_параметров_услуги, Параметр_для_услуги и класс Параметр_услуги формируем список параметров класса Услуга_ответственного_хранения. 
     Перейдем к формированию шаблона тарифа. Используя метакласс Шаблон_тарифа добавляем класс Тариф_на_услуги_ответственного_ хранения. Далее необходимо описать шаблоны предикатов. Для этого используя метакласс Шаблон_предиката и ассоциацию с ролью Параметр_шаблона_предиката опишем  необходимые шаблоны:
1.	Средний_объем_хранннения_в_день =?.
2.	Оборачиваемость=?.
3.	Месячный_бюджет=?.
4.	 Для_модели_паллет=?.
Используя ассоциацию с ролью Состав_шаблонов_правил и ассоциативный класс Шаблон_правила сформируем список шаблонов правил для класса Тариф_на_услуги_ответственного_ хранения.
Формируем шаблоны правил. Для этого необходимо сформировать необходимые шаблоны для условий и решений. Необходимы следующие шаблоны условий:
1.	Средний_объем_хранннения_в_день=?
and Оборачиваемость=?
and Для_модели_паллет=?.
     Перейдем к формированию состава шаблонов решений. Используя метакласс Шаблон_решения и ассоциацию с ролью Параметр_решения опишем необходимые шаблоны решений:
2.	Месячный_бюджет=?.
. Объявим шаблон правила 1.Шаблон правила. и включим в его состав по ассоциации Состав_шаблонов_условий  шаблон №1 а по ассоциации с ролью Состав_шаблонов_решений шаблон №2.  
        Необходимые шаблоны для класса Услуга_ответственного_хранения сформированы. 
Перейдем к формированию варианта тарифа. Используя класс Тариф_на _услуги и ассоциацию с ролью Услуга_по_тарифу  объявим объект 1.Тариф на услугу.  Имя(1)={ “Тариф на услугу ответственного хранения” }. В соответствии с шаблоном тарифа для каждого правила необходимо подобрать шаблон для правила. В нашем случае используется один шаблон для правил 1,Шаблон правила.
Для строки № 4 документа (рис. 9) создадим правило 4.Правило.  Используя ассоциацию с ролью По_шаблону_правила выберем шаблон 1.Шаблон правила.  Зададим значения параметров правила для каждого из предикатов условия и решения:
1.	Средний_объем_хранннения_в_день =100.
2.	Оборачиваемость=0.
3.	Месячный_бюджет=51750.
4.	 Для_модели_паллет= 2. М2-120*80*до185.
Для строки №5 создадим правило 5.Правило. Используем также шаблон 1.Шаблон. Зададим значения параметров правила для каждого из предикатов условия и решения:
1.	Средний_объем_хранннения_в_день =100.
2.	Оборачиваемость=1.
3.	Месячный_бюджет=69750.
4.	 Для_модели_паллет= 2. М2-120*80*до185.
     Показано, что модель классов этапа проектирования поддерживает работу с тарифами на ответственное хранение.
     Продолжим проверку модели, представленной на рис. 8. Проверим возможность описания данных третьей строки документа, описывающего тарифы на грузоперевозки (рис. 1).
     Для описания модели, представленной на рис. 2, необходимо включить в классификатор услуг класс Услуга_грузоперевозки. Далее требуется расширить список требуемых параметров. Метакласс Параметр позволяет описать необходимые параметры: Вес_груза, Объем_груза, Количество_паллет, Длительность_перевозки, Требуемый_класс_авто, Вариант_маршрута, Стоимость_часа, Стоимость_км_перепробега. Для параметра Требуемый_класс_авто: Класс_авто необходимо используя метакласс Классификатор_объектов заполнить схему классификации авто начиная с класса Класс_авто. Для параметра Вариант_маршрута  необходимо используя метакласс Перечисление объявить  перечисление Тип_маршрута. На рис. 7 приведена диаграмма классов, описывающая решение для работы с параметрами типа Классификатор_объектов. Используя ассоциации с ролями Состав_параметров_услуги, Параметр_для_услуги и класс Параметр_услуги формируем список параметров класса Услуга_грузоперевозки. 
     Перейдем к формированию шаблона тарифа. Используя метакласс Шаблон_тарифа добавляем класс Тариф_на_услуги_грузоперевозки. Далее необходимо описать шаблоны предикатов. Для этого используя метакласс Шаблон_предиката и ассоциацию с ролью Параметр_шаблона_предиката опишем  необходимые шаблоны предикатов:
5.	Вес_груза<=?.
6.	Вес_груза>?.
7.	Объем_груза<=?.
8.	Объем_груза>?.
9.	Количество_паллет<=?.
10.	Количество_паллет>?.
11.	 Длительность_перевозки<=?.
12.	Длительность_перевозки>?.
13.	Требуемый_класс_авто=?.
14.	Вариант_маршрута=?.
15.	Стоимость_часа=?.
16.	 Стоимость_км_перепробега=?.
Используя ассоциацию с ролью Состав_шаблонов_правил и ассоциативный класс Шаблон_правила сформируем список шаблонов правил для класса Тариф_на_услуги_грузоперевозки. Формируем шаблоны правил. Для этого необходимо сформировать необходимые шаблоны для условий и решений. Необходимы следующие шаблоны условий:
3.Вес_груза<=?
and Вес_груза>?
and Объем_груза>=?
and Объем_груза<?
and Количество_паллет<=?
and Количество_паллет>?.
 and Длительность_перевозки<=?
and Длительность_перевозки>?
and Требуемый_класс_авто=?
and Вариант_маршрута=?
     Перейдем к формированию состава шаблонов решений. Используя метакласс Шаблон_решения и ассоциацию с ролью Параметр_решения опишем необходимые шаблоны решений:
4.Стоимость_часа=?.
5. Стоимость_км_перепробега=?.
Объявим шаблон правила 2.Шаблон правила и включим в его состав по ассоциации Состав_шаблонов_условий  шаблон №3, а по ассоциации с ролью Состав_шаблонов_решений шаблонs №4, 5.  Необходимые шаблоны для класса Услуга_грузоперевозки сформированы. 
     Перейдем к формированию варианта тарифа. Используя класс Тариф_на _услуги и ассоциацию с ролью Услуга_по_тарифу  объявим объект 2.Тариф на услугу.  Имя(2)={ “Тариф на услугу грузоперевозки” }. В соответствии с шаблоном тарифа для каждого правила необходимо подобрать шаблон для правилю. В нашем случае используется один шаблон для правил 2,Шаблон правила.
     Для строки № 3 документа (рис. 1) создадим правило 5.Правило.  Используя ассоциацию с ролью По_шаблону_правила выберем шаблон 2.Шаблон правила.  Зададим значения параметров правила для каждого из предикатов условия и решения:
5.	Вес_груза<=1.5.
6.	Вес_груза>0.0.
7.	Объем_груза<=10.0.
8.	Объем_груза>1/5.
9.	Количество_паллет>0.0.
10.	Количество_паллет<=4.
11.	 Длительность_перевозки<=4.
12.	Длительность_перевозки>0.0.
13.	Требуемый_класс_авто=Закрытые_автомобили.
14.	Вариант_маршрута=По_городу.
15.	Стоимость_часа=495.0.
16.	 Стоимость_км_перепробега=16.0.

     Показано, что модель классов этапа проектирования поддерживает работу с тарифами на грузоперевозки. Используемая методика проверки полноты и корректности разработанных моделей классов показала свою работоспособность и эффективность. Отметим, что при проверке данного примера было выявлено и исправлено несколько ошибок, которые мешали и не позволяли выполнить операции тестирования.
Использование обобщенной объектной модели для правил (версия 1). Вернемся к рассмотрению модели классов для примера, представленной на рис. 2. Объектная модель этапа анализа позволила представить задачу работы с тарифами на грузоперевозки в виде потоков данных, связывающих переменные заданных классов и функций работы с ними (рис. 3). Модели метаклассов, представленные на рис. 4, 8, показывают последовательные шаги обобщения проектной модели для повышения уровня ее абстрагирования. Однако, даже модель, представленная на рис. 8 и содержащая класс Правило, может быть применена только для описания тарифов на услуги. 
     Рассмотрим обобщенную модель метаклассов для правил (рис. 11). 
 
Рис. 11. Обобщенная модель классов для правил
Рассмотрим возможности этой модели для решения задач работы с нормативными данными по услугам. Класс Тариф_на услуги, объявим в метаклассе Классификатор_объектов, Классификатор_услуг описывается в том же метаклассе. Используя метакласс Классификатор_объектов, ассоциацию с ролью Спецификация_классоов и метакласс Классификатор_деятельности опишем необходимые классы, функции доступа, операции, правила, решения, условия.  Для класса Тариф_на_услугу создаем необходимый набор компонентов типа Правило. Для каждого *.Правило  описываем соответствующие компоненты 
Предпосылка(*.Правило )->*.Условие ; 
Решение_для_правила (*.Правило )->>*.Решение. 
В классе Объект создаем конкретный элемент *.Тариф_на_услуги. Для него генерируем схему потоков в соответствии с  шаблонами деятельности.  Схемы потоков позволяют автоматизировать поиск решений на основе данных запроса. 
     Использование обобщенной объектной модели для правил (версия 2).
Рассмотрим расширенный классификатор компонентов для описания моделей ИС (рис. 12).
 
Рис. 12. Фрагмент классификатора компонентов
Номера в наименованиях соответствуют значению ID_CLASS в классификаторе CHEM_CLASS. На вершине дерева классификации находится стереотип Компонент 102. Его потомками являются Простой тип 105 и Класс ПО 32. Потомками стереотипа Простой тип 105  являются Перечисление 107 и Базовый тип 106. Отметим введение подкласса Функция 139, позволяющего описывать различные функциональные зависимости между объектами предметной области. Последовательно рассмотрим  класс Функция 139.и его подклассы.
     Модель для класса Функция 139. Диаграмма классов для описания ролей представлена на рис. 13.

 
Рис. 13. Диаграмма классов модели компонента Функция 139
Введены следующие подклассы  данного класса:
	Роль 108  обеспечивает описание ассоциаций между объектами в виде функций доступа;
	Предикат 145  обеспечивает описание предикатов, определенных на значениях других функций;
	АрифмВ 141  обеспечивает описание арифметических выражений с аргументами в виде функций;
	ЛВ 143    обеспечивает описание логических выражений с аргументами в виде функций;
	Правило 140 обеспечивает описание правил с условием и решениями в  виде функций.
     Для функций с результатом численного типа задана единица измерения (роль ЕИ значения). Ассоциация с ролью Тип значения задает область значений функции. Ассоциация с ролью Вариант МН задает вариант множественности функции. Ассоциация с ролью Состав функций позволяет описать список функций для каждого класса из метакласса Классификатор объектов. Для функций указывается список аргументов (ассоциативный класс Аргумент и ассоциации с ролями Состав аргументов и Функция для аргумента. 
     Для пары функция – объект задаются значения в соответствии с вариантом множественности. Ассоциативный класс Значение функции обеспечивает хранение значений функций для объектов. Области значений функций различных классов различны. Для каждого типа значений введены соответствующие подклассы (Значение Ch, Значение Int, Значение Real, Значение Date, Результат-объект, Результат-класс, Результат-перечисление).
     Модель для класса Роль 108. Диаграмма классов для описания ролей представлена на рис. 14.
 
Рис. 14. Диаграмма классов  модели для класса Роль
Введено два подкласса Роль-elem – значением роли являются объекты или элементы базовых типов и Роль-class – значением роли являются классы из метакласса Классификатор _объектов_ПО. Ассоциация с ролью Для класса  определяет принадлежность роли. Ассоциация с ролью Тип результата  определяет область значений роли. Ассоциация с ролью Аргументы функции обеспечивает выбор значения роли из списка значений аргументов. Если аргументы отсутствуют, то значение роли должно быть введено. Ассоциация с ролью Вариант реализации позволяет указать способ реализации роли (поле таблицы базы данных или динамически определенная характеристика объекта).
     Модель для класса Предикат 145. Диаграмма классов для описания ролей представлена на рис. 15.
 
Рис. 15. Диаграмма классов модели для класса Предикат
Предикаты классифицированы в соответствии с оператором сравнения. Рассматриваются двуместные предикаты. Аргументы предиката заданы как функции.
     Модель для класса ЛВ 143. Диаграмма классов для описания логических выражений представлена на рис. 16.

 

Рис. 16. Диаграмма классов  модели для класса Логическое выражение
Классификация ЛВ 143 проведена в соответствии с вариантами логических операторов. Аргументами логического выражения могут выступать другие логические выражения.  Ассоциация с ролью Аргумент-ЛВ) или предикаты (ассоциация с ролью Аргумент-предикат).
     Модель для класса АрифмВ 141. Диаграмма классов для описания арифметических выражений представлена на рис. 17.
 
Рис. 17. Диаграмма классов  модели для класса Арифметическое выражение
Классификация АрифмВ 141 проведена в соответствии с вариантами арифметических операторов. Аргументами логического выражения могут выступать другие арифметические выражения или функции с результатами численного типа.  
     Модель для класса Правило 140. Диаграмма классов для описания правил представлена на рис. 18.
 
Рис. 18. Диаграмма классов  модели для класса Правило
Ассоциативный класс Решение Пр и ассоциации с ролями Решения и Функция для решения позволяют описать список решений для правила. Каждым элементом решения является элемент класса Функция 139.
Ассоциация с ролью Условие позволяет задать булеву функцию в качестве условия для правила. 

3.	Разработка модели хранения

Для разработки диаграммы ER воспользуемся редактором Microsoft Visio в форме Object Relational (Metric).  Переход от модели классов к модели ER не однозначен. Существует много вариантов преобразования. В представленной реализации модели ER приняты следующие решения. Поддерживается одноаспектная классификация всех компонентов проекта. В сущность FUNCT_R включены поля для всех ее подклассов. Для всех подклассов классов предметной области выделена одна сущность PROD. Исключение сделано для сущности EI и указания базовой единицы измерения количества (поле BASE_EI). Для значений функций с различными типами результатов выделена одна ассоциативная сущность ROLE_VAL с полями для каждого типа значений.
 
Рис. *.*. ERD для решения задач работы с тарифами на услуги
     Сущность CHEM_CLASS обеспечивает хранение схемы классификации всех компонентов проекта, представленных на рис. 12. 
     Сущность FUNCT_R обеспечивает моделирование класса Функция 139, локальная модель классов которой представлена на рис. 13. Поле CL_OB указывает на владельца функции, поле TYPE_F указывает на тип функции, поле TYPE_RES указывает на тип результата функции, поле VAR_MN указывает на вариант множественности функции, поле IF_RULE указывает на условие для правила. 
     Ассоциативная сущность ARG_FUNCT позволяет описать аргументы функции. 
     Ассоциативная сущность DECISION_RULE позволяет описать решения для правила, являющиеся функциями. 
     Сущность PROD обеспечивает хранение данных об объектах предметной области различных классов.
     Ассоциативная сущность ROLE_VAL позволяет хранить значения функций с результатами различных типов для объектов различных классов и различных вариантов множественности.
5. Разработка процедур поддержки работы с правилами и ограничениями
В связи с включением классификатора перечислений в состав CHEM_CLASS необходима новая процедура для занесения значений перечислений:

create or alter procedure INS_VAL_ENUM_R(
    PIDENUM integer,
    PSHNAME varchar(15),
    PNAME varchar(150),
    PVAL double precision)
returns (
    ONEW integer,
    ONUM integer,
    ORES integer)
/*функция: Добавляет новое значение pIdEnum 
  вход:pIdENum - ид. перечисления (в CHEM_CLASS)
       pShName -  обозначение
       pName -  имя
       pVal - численное значение
  выход: oNum - порядковый номер значения в списке перечисления
         oRes - 0- операция не выполнена, 1 - операция выполнена успешно
  эффекты: */

Для добаления  функций необходима соответствующая процедура:
create or alter procedure INS_FUNCT(
   pShortName  VARCHAR(50),
   pName        VARCHAR(250),
   pTypeF       INTEGER,
   pTypeRes INTEGER,
   pVarMn INTEGER,
   pEiR INTEGER,
   pClOb integer,
   pIfRule integer,
   pVarReal integer,
   pInvR integer
   )
returns(oIdF integer, oYesName integer, oYesTypeF integer,  
         oYesTypeRes integer, oYesEI integer, oYesIf integer,oYesClOb integer,oRes integer)
/*функция: Создает новую функцию правила
вход: pShortName - обозначение функции,
   pNAME - имя функции,
   pTypeF - тип функции из CHEM_CLASS,
   pTypeRes - тип результата,
   pVarMN - вариант множественности роли,
   pEIR - ЕИ значия для численной фукции
   pClOb - класс объекта-владельца (только для ролей и правил),
   pIfRull - логическое выражение (только для правил),
   pVarReal - вариант реализации (только для ролей),
   pInvR - ссылка на основную роль (только для инверсных ролей

выход: oIdА - id роли,
       oRes - 0 - ошибка, 1 - успешное выполнение,
эффекты:
  1. Проверяется уникальность имени и обозначения функции
  2. Проверяется корректность указания типа функции
  3. Проверяется наличие класса аргумента и результата
требования:
1. Для функций с результатом численного типа необходимо указать ЕИ 
*/
Для добавления аргументов функций создаем следующую процедуру:
create or alter procedure INS_ARG_F(pIdF integer, pArg integer)
  returns (oYesF integer, oYesArg integer, oNum integer,
           oYesEI integer, oRes integer)
/*функция: добавляет аргумент функции
  вход: pIdF - id функции,
        pArg - тип аргумента из CHEM_CLASS
  выход: oYesArg - есть аргумент, 
         oN - локальный номер аргумента
         oRes - 0 - ошибка, 1 - ок
  требование: 1. Ограничение - типы аргументов только чиисленные или логические*/
В связи с изменением модели описания параметров необходима новая процедура формирования пустой записи значений при создании объекта:
create or alter procedure COPY_FUNCT_PROD (
    PIDPROD integer)
returns ( ORES integer)
/*функция: Формирует список для значений функций экземпляра pIdProd
  вход:pIdProd - ид. продукта
  выход:oRes - 0 - ошибка 1 - список сформирован
  эффекты: */
В связи с изменением структуры описания параметров объектов необходимо внести изменения в процедуру создания объекта:
create or alter procedure INS_OB (
    PIDCLASS integer,
    PSHNAME varchar(50),
    PNAME varchar(200),
    PCONF integer)
returns (
    OIDPROD integer,
    ORES integer)
/*функция: Создает новый экземпляр продукции
  вход:pIdClass - ид. продукта
       pShName - обозначение продукта
       pName - имя продукта
       pConf - флаг шаблона конфигуратора (0- обычный объукт, 1 - шаблон)
  выход: oIdProd - ид. нового продукта
         oRes - 0 - ошибка 1 - список сформирован
  эффекты: */

Спецификация процедуры редактирования значений функции представлена ниже:
create or alter procedure UPDATE_VAL_ROLE(pIdRole integer, pIdOb integer,pValCh varchar(50),
          pValInt integer, pValReal double precision, pValDate TIMESTAMP, pIdObRes integer,
           pIdClRes integer,pIdEnumRes integer,pValBool integer)
  returns(oRes integer)
/* функция: Записывает значение роли pIdRole для объекта pIdOb;
   вход:pIdRole - id роли,
        pIdOb - id объекта из PROD,
        pValCh - значение роли varchar(50),
        pValInt - значение роли int, 
        pValReal - значение роли real, 
        pIdObRes - ссылка на объект-результат или на значение перечисления
        
   выход: oRes - 0 - ошибка, > 0 - успешное выполнение операции
   эффекты:
   требования:
*/
Спецификация процедуры поиска значений функции объекта представлена ниже:
create or alter procedure FIND_VAL_PAR(pIdOb integer, pIdRole integer)
    returns(oNameRole varchar(50), oValCh varchar(50),oValInt integer, oValReal double precision, 
            oValDate TIMESTAMP,oEnumRes integer,oObRes integer,oClRes integer,
            oEI integer, oShNameEI varchar(10),oNameRes varchar(50),oNameClRes varchar(50),
            oValBool integer,oRes integer)
/*функция: Читает значение параметра pIdRole объекта pIdOb
  вход:
    pIdOb - id объекта
  выход:
    oNameRole - имя роли,
    oValInt - значение int,
    oValReal - значение real,
    oValDate - значение TIMESTAMP,
    oEnumRes - значение enum,
    oObRes - значение объект,
    oClRes - значение класс,
    oEI - ид. ЕИ параметра,
    oShNameEI - обозначение ЕИ,
    oNameRes - имя результата,
    oNameClRes - имяя класса результата,
    oRes - 0 - ошибка, 1 - операция выполнена
  эффекты:
  требования:
*/
Спецификация процедуры поиска значений всех функций объекта представлена ниже:
create or alter procedure FIND_VAL_ALL_PAR(pIdOb integer)
    returns(oNameRole varchar(50), oValInt integer, oValReal double precision, 
            oValDate TIMESTAMP,oEnumRes integer,oObRes integer,oClRes integer,
            oEI integer, oShNameEI varchar(10),oNameRes varchar(50),
            oNameClRes varchar(50),oValBool integer,oRes integer)
/*вход:
    pIdOb - id объекта
  выход:
    oNameRole - имя роли,
    oValInt - значение int,
    oValReal - значение real,
    oValDate - значение TIMESTAMP,
    oEnumRes - значение enum,
    oObRes - значение объект,
    oClRes - значение класс,
    oEI - ид. ЕИ параметра,
    oShNameEI - обозначение ЕИ,
    oNameRes - имя результата,
    oNameClRes - имяя класса результата,
    oRes - 0 - ошибка, 1 - операция выполнена
  эффекты:
  требования:
*/
Спецификация процедуры формирования списка решений правила представлена ниже:
create procedure INS_DEC_F(pIdF integer,pIdDec integer)
  returns (oYesF integer, oYesDec integer,
           oNum integer, oRes integer)
/*функция: добавляет решение в правило
  вход: pIdF - id функции,
        pDec - решение из FUNCT_R,
  выход: oYesF - есть правило, 
         oYesDec - есть решение,
         oN - локальный номер решения
         oRes - 0 - ошибка, 1 - ок
  требование: 1. Ограничение - типы решений только из FUNCT_RULE
*/
Спецификация процедуры, обеспечивающей выбор значений для роли из списка возможных с проверкой правил представлена ниже:
create or alter procedure CASE_ARG(pRole integer, pOb1 integer, pOb2 integer)
  returns( oArg integer, oValBool integer, oRes integer)
/*функция: возвращает выбранный аргумент и его значение;
  вход: pRole - ид. роли,
           pOb - ид. объекта для роли
   выход: oArg - выбранный аргумент,
              oRes - 0 -ошибка, 1 - ok.
   эффекты: Пока только для ролей вещественного типа
   требование:     
*/
Спецификация процедуры, обеспечивающей проверку цепочки правил для активизации функции объекта представлена ниже:
create or alter procedure CALC_RULE(pIdOb1 integer,pIdF integer,pIdOb2 integer)
  returns (oValBool integer,oRes integer)
/*функция: Проверяет возможность активизации функции объекта по цепочке правил;
  вход: pIdF - ид. роли,
           pIdOb1 - ид.  услуги
           pIdOb2 - ид. тарифа
   выход: oValBool - 0 - активизация запрещена, 1 - разрешена,
              oRes - 0 -ошибка, 1 - ok.
   эффекты: Пока только для ролей вещественного типа
   требование:     
*/
Спецификация процедуры вычисления значения предиката с вычислением значений аргументов для объекта представлена ниже:
create or alter procedure CALC_PRED (
    PIDPRED integer,
    PIDOB1 integer,
    PIDOB2 integer)
returns (
    OYESOB1 integer,
    OYESPRED integer,
    OYESOB2 integer,
    OVALBOOL integer,
    ORES integer)
/*функция: Вычисляет значение предиката pIdF объекта pIdOb на основе правил из pIdObRule;
  вход: pIdOb1 - ид. объекта 1,
        pIdOb2 - ид. объекта 2,
        pIdPred - предикат вычисляемый параметр,
  выход: oYesOb - есть объект,
         oYesF  - есть параметр,
         oYesObRule - есть владелец правил,
         oNum - номер значения,
         oVal - значение,
         oRes - 0 - ошибка, 1 - ок
  требование: 1. Ограничение - значение  только для типа real (double precision
*/
Спецификация процедуры вычисления значения арифметического выражения представлена ниже:
create or alter procedure CALC_AR(pIdAr integer,pIdOb1 integer,pIdOb2 integer)
  returns (oYesOb integer, oYesAr integer,oValAr double precision,oRes integer)
/*функция: Вычисляет значение арифметического выражения pIdAr из pIdOb1;
  вход: pIdOb1 - ид. объекта 1,
        pIdAr - id арифметического выражения,
  выход: oYesOb - есть объект,
         oYesAr  - есть параметр,
         oVal - значение,
         oRes - 0 - ошибка, 1 - ок
  требование: 1. Ограничение - значение  только 
*/
Вычисление логического выражения обеспечивает процедура, спецификация которой представлена ниже:
create or alter procedure CALC_LOG(pIdLog integer,pIdOb1 integer,pIdOb2 integer)
  returns (oYesOb integer, oYesLog integer,oValBool integer,oRes integer)
/*функция: Вычисляет значение логического выражения pIdLog из pIdOb1;
  вход: pIdOb1 - ид. объекта 1,
        pIdOb2 - ид. объекта 1,
        pIdLog - id логического выражения,
  выход: oYesOb - есть объект,
         oYesLog  - есть параметр,
         oValBool - значение,
         oRes - 0 - ошибка, 1 - ок
  требование: 1. Ограничение - значение  только 
*/
Спецификация общей процедуры, обеспечивающей вычисление значений функции любого типа для объекта представлена ниже:
create or alter procedure CALC_VAL_F(pIdF integer, pIdOb1 integer, pIdOb2 integer)
  returns (oYesOb integer, oYesF integer, oNum integer, oValCh varchar(50),oValInt integer,
      oValReal double precision, oValDate DATE, oObRes integer, oClRes integer,oEnumRes integer,
      oValBool integer,oRes integer)
/*функция: Вычисляет значение параметра pIdF объекта pIdOb на основе правил из pIdObRule;
  вход: pIdOb1 - ид. объекта (услуги),
        pIdF - вычисляемый параметр,
        pIdOb2  - владелец правил;
  выход: oYesOb - есть объект,
         oYesF  - есть параметр,
         oYesObRule - есть владелец правил,
         oNum - номер значения,
         oVal - значение,
         oRes - 0 - ошибка, 1 - ок
  требование: 1. Ограничение - значение  только для типа real (double precision
*/

Скрипты метаданных представлены в Приложении 1 
6. Подготовка примеров работы с правилами и ограничениями 
Расширение классификатора
Примеры расширения классификатора:
select * from INS_CLASS(32, "КлС","Сущность",null);
/* oIdClass = 125*/
select * from INS_CLASS(32, "ЗКл","Зависимый класс",null);
/* oIdClass = 126*/
select * from INS_CLASS(1, "Услуга","Услуга",15);
/* oIdClass = 127*/
select * from INS_CLASS(1, "Перевозка","Услуга перевозки",15);
/* oIdClass = 128*/
select * from INS_CLASS(127, "Отв.хранение","Услуга ответственного хранения",15);
/* oIdClass = 129*/ 
select * from INS_FUNCT("СтПер","Стоимость перевозки", 146,    /*146 - Арифм выражение Сумма*/
                            118,         /*118 - real*/
                             2,           /*2 - "1" ENUM_VAL_R*/
                             17,           /*17 - руб*/
                            128,         /*128 - Услуга перевозки*/
                            null,         /* логическое выражение для if*/
                              15,    /*15 - динамическая роль из перечисления Способ реализации*/
                            null);    /* - основная роль*/
/*oIdF= 9, oRes=1*/

/*Указать аргументы. Функции для аргументов должны быть объявлены ранее*/

/**   procedure INS_ARG_F(pIdF integer, pArg integer)
  returns (oYesF integer, oYesArg integer, oNum integer,
           oYesEI integer, oRes integer)  **/

select * from INS_ARG_F(9, 11)  /*11.СГор*/
select * from INS_ARG_F(9, 12)  /*11.СМГор*/
select * from INS_ARG_F(9, 10)  /*11.С Вр*/
/**************************************************************************/
Результаты расширения представлены ниже ( используем процедуру FIND_GR_GR (PIDGR integer))
Перечисления (select * from FIND_GR_GR (107))
OMAINGR	OIDGR	ONAMEGR	OSHORTNAMEGR	OTERM
105	107	Перечисление	Переч	0
107	133	Вариант множественности	B-M	1
107	134	Операнд	опер	1
107	135	Вариант маршрута	Вар. маршр	1
107	136	Способ расчета	Способ расч.	1
107	137	Вариант реализации роли	Реализ. роли.	1

Базовые типы (select * from FIND_GR_GR (106))
OMAINGR	OIDGR	ONAMEGR	OSHORTNAMEGR	OTERM
105	106	Базовый тип	БТ	0
106	114	Численный тип	ЧТ	0
114	117	integer	int	1
114	118	real	real	1
106	115	Дата-время	ДВ	1
106	116	строка	str	1
106	153	boolean	bool	1
 	 	 	 	 

Классификатор функций правил (select * from FIND_GR_GR (139))
OMAINGR	OIDGR	ONAMEGR	OSHORTNAMEGR	OTERM
138	139	Функция	Функция	0
139	108	Роль	R	0
108	109	Роль класса	RCl	1
108	110	Роль-элемент	REl	1
108	111	Роль атрибут	RAtr	0
111	112	Атрибут-поле	AtrF	1
111	113	Динамический атрибут	DAtr	1
139	140	Правило	Правило	1
139	141	Арифметическое выражение	Арифм. выр.	0
141	146	Сумма	+	1
141	147	Вычитание	-	1
141	148	Умножение	*	1
141	149	Деление	/	1
141	159	Присвоение	:=	1
139	142	Процедура	Процедура	1
139	143	Логическое выражение	Лог. выраж.	0
143	150	И	and	1
143	151	ИЛИ	or	1
143	152	НЕ	not	1
139	145	Предикат	Предикат	0
145	154	Меньше	<	1
145	155	Меньше-равно	<=	1
145	156	Равно	=	1
145	157	Больше-равно	>=	1
145	158	Больше	>	1


Примеры объявления функции для правил:
select * from INS_FUNCT("G","Вес груза", 110,    /*110 - Роль элемента*/
                            118,         /*118 - real*/
                             2,           /*2 - "1" ENUM_VAL_R*/
                             5,           /*5 - т в EI*/
                            128,         /*128 - Услуга перевозки*/
                            null,         /* логическое выражение для if*/
                              15,    /*15 - динамическая роль из перечисления Способ реализации*/
                            null);    /* - основная роль*/
/*oIdF= 1, oRes=1*/

select * from INS_FUNCT("СтПер","Стоимость перевозки", 146,    /*146 - Арифм выражение Сумма*/
                            118,         /*118 - real*/
                             2,           /*2 - "1" ENUM_VAL_R*/
                             17,           /*17 - руб*/
                            128,         /*128 - Услуга перевозки*/
                            null,         /* логическое выражение для if*/
                              15,    /*15 - динамическая роль из перечисления Способ реализации*/
                            null);    /* - основная роль*/
/*oIdF= 9, oRes=1*/

/*Указать аргументы. Функции для аргументов должны быть объявлены ранее*/

/**   procedure INS_ARG_F(pIdF integer, pArg integer)
  returns (oYesF integer, oYesArg integer, oNum integer,
           oYesEI integer, oRes integer)  **/

select * from INS_ARG_F(9, 11)  /*11.СГор*/
select * from INS_ARG_F(9, 12)  /*11.СМГор*/
select * from INS_ARG_F(9, 10)  /*11.С Вр*/
/**************************************************************************/


Функции доступа для правил (select * from FUNCT_R )
ID_F	SHORT_NAME	NAME	TYPE_RES	VAR_MN	EI_R	TYPE_F	CL_OB	IF_RULE	VAR_REAL	INV_R
1	G	Вес груза	118	2	5	110	128	 	15	 
2	V	Объем груза	118	2	16	110	128	 	15	 
3	КлАвто	Требуемый класс авто	121	2	 	109	128	 	15	 
4	Вар.расч.	Вариант расчета стоимости	136	2	 	110	128	 	15	 
5	G1	Вес 1	118	2	5	110	131	 	15	 
6	Т ч	Планируемое время (ч)	118	2	14	110	128	 	15	 
7	ПробегГ	Пробег по городу (км)	118	2	18	110	128	 	15	 
8	ПробегМГ	Пробег по области (км)	118	2	18	110	128	 	15	 
9	СтПер	Стоимость перевозки	118	2	17	146	128	 	15	 
10	СтВр	Стоимость по времени	118	2	17	148	128	 	15	 
11	СтГор	Стоимость по городу	118	2	17	148	128	 	15	 
12	СтМГор	Стоимость по области	118	2	17	148	128	 	15	 
13	КлАвто 1	Класс авто 1	121	2	 	109	131	 	15	 
14	КлАвто 2	Класс авто 2	121	2	 	109	131	 	15	 
15	КлАвто 3	Класс авто 3	121	2	 	109	131	 	15	 
16	G2	Вес 2	118	2	5	110	131	 	15	 
17	G3	Вес 3	118	2	5	110	131	 	15	 
18	V 1	Объем груза 1	118	2	16	110	131	 	15	 
19	V 2	Объем груза 2	118	2	16	110	131	 	15	 
20	V 3	Объем груза 3	118	2	16	110	131	 	15	 
21	Т1 ч	Константа по времени 1 (ч)	118	2	14	110	131	 	15	 
22	Т2 ч	Константа по времени 2 (ч)	118	2	14	110	131	 	15	 
23	С Т1.1	Расценка по времени 1.1 (р/ч)	118	2	20	110	131	 	15	 
24	С Т1.2	Расценка по времени 1.2 (р/ч)	118	2	20	110	131	 	15	 
25	С Т2.1	Расценка по времени 2.1 (р/ч)	118	2	20	110	131	 	15	 
26	С Т2.2	Расценка по времени 2.2 (р/ч)	118	2	20	110	131	 	15	 
27	С Г1	Расценка по городу 1 (р/км)	118	2	19	110	131	 	15	 
28	С Г2	Расценка по городу 2 (р/км)	118	2	19	110	131	 	15	 
29	С Г3	Расценка по городу 3 (р/км)	118	2	19	110	131	 	15	 
30	С Об1	Расценка по области 1 (р/км)	118	2	19	110	131	 	15	 
32	С Об3	Расценка по области 3 (р/км)	118	2	19	110	131	 	15	 
33	К Т0	Выбранная Расценка по времени (р/ч)	118	2	20	144	131	 	15	 
34	К Об0	Выбранная Расценка по области  (р/км)	118	2	19	144	131	 	15	 
35	К Г0	Выбранная Расценка по городу(р/км)	118	2	19	144	131	 	15	 
36	ПредКлАвто 1	По классу авто 1	153	2	 	156	131	 	15	 
37	ПредКлАвто 2	По классу авто 2	153	2	 	156	131	 	15	 
38	ПредКлАвто 3	По классу авто 3	153	2	 	156	131	 	15	 
39	ПG1	По весу 1	153	2	5	155	131	 	15	 
40	ПG2	По весу 2	153	2	5	158	131	 	15	 
41	ПG1.3	По весу 1.3	153	2	5	155	131	 	15	 
42	ПG1.4	По весу 1.4	153	2	5	158	131	 	15	 
43	ПG1.5	По весу 1.5	153	2	5	155	131	 	15	 
44	ПV1.1	По объему 1.1	153	2	16	155	131	 	15	 
45	ПV1.2	По объему 1.2	153	2	16	158	131	 	15	 
46	ПV1.3	По объему 1.3	153	2	16	155	131	 	15	 
47	ПV1.4	По объему 1.4	153	2	16	158	131	 	15	 
48	ПV1.5	По объему 1.5	153	2	16	155	131	 	15	 
49	ПТ1.1	По времени 1.1 (ч)	153	2	14	155	131	 	15	 
50	ПТ1.2	По времени 1.2 (ч)	153	2	14	158	131	 	15	 
51	ПТ1.3	По времени 1.3 (ч)	153	2	14	155	131	 	15	 
52	С Г0	Расценка по городу 0 (р/км)	118	2	19	110	131	 	15	 
53	С МГ0	Расценка по области 0 (р/км)	118	2	19	110	131	 	15	 
54	С Т0	Расценка по времени 0(р/ч)	118	2	20	110	131	 	15	 
62	С Об2	Расценка по области 2 (р/км)	118	2	19	110	131	 	15	 
63	ЛВ1	И ПрГр1диап	153	2	 	150	131	 	15	 
64	ЛВ2 ИЛИ	ИЛИ ЛевГр2диап	153	2	 	151	131	 	15	 
65	ЛВ3 И	И ПрГр2диап	153	2	 	150	131	 	15	 
66	ЛВ4 И	И 2 диапазон	153	2	 	150	131	 	15	 
67	ЛВ5 И	И ЛевГр3диап	153	2	 	150	131	 	15	 
68	ЛВ6 И	Пр. граница 3 диап.	153	2	 	150	131	 	15	 
69	ЛВ7 И	 3 диап.GV	153	2	 	150	131	 	15	 
71	ЛВТ1 ИЛИ	ИЛИ Лев. граница 2 диапазона Т	153	2	 	151	131	 	15	 
72	ЛВТ3 И	И 2 диапазон времени Т	153	2	 	150	131	 	15	 
73	ПР 1	Правило по классу авто 1	153	2	 	140	131	36	15	 
74	ПРА 2	Правило по классу авто 2	153	2	 	140	131	37	15	 
75	ПРА 3	Правило по классу авто 3	153	2	 	140	131	38	15	 
76	ПР GV 1	Правило GV 1	153	2	 	140	131	63	15	 
77	ПР GV 2	Правило GV 2	153	2	 	140	131	66	15	 
78	ПР GV 3	Правило GV 3	153	2	 	140	131	69	15	 
79	ПР Т1	Правило Т1	153	2	 	140	131	49	15	 
80	ПР Т1.2	Правило Т1.2	153	2	 	140	131	72	15	 
81	ПР Т2.1	Правило Т2.1	153	2	 	140	131	49	15	 
82	ПР Т2.2	Правило Т2.2	153	2	 	140	131	72	15	 
83	АрФ СтГ	Стоимость перевозки по городу	118	2	18	148	128	 	15	 
84	АрФ СтМГ	Стоимость перевозки по области	118	2	18	148	128	 	15	 
85	АрФ СтТ	Стоимость перевозки по времени	118	2	18	148	128	 	15	 
86	АрФ СтП	Общая стоимость перевозки	118	2	18	146	128	 	15	 

Формирование объектов для примера.
Заказы на услуги:
select * from INS_OB(128,"ЗП 002","Заказ на перевозку 002",0);

/*96 oRes=1  шаблон для ролей сформирован.*/

select * from INS_OB(128,"ЗП 003","Заказ на перевозку 003",0);

/*100 oRes=1  шаблон для ролей сформирован.*/

select * from INS_OB(128,"ЗП 004","Заказ на перевозку 003",0);

/*101 oRes=1  шаблон для ролей сформирован.*/

Тариф на услуги перквозки:
select * from INS_OB(131,"TП 001,"Тариф  на перевозку 001",0);

/* idOb=102  oRes=1  шаблон для ролей сформирован*/
/************************************************************/
7. Тестирование процедур конструктора и исполнителя расчетов на основе использования правил  
Формирование списка типовых услуг.
Значения функций для выбранных объектов:
1)	95. Заказ на перевозку 001 класса 128. Услуга перевозки
ONAMEROLE	OVALINT	OVALREAL		OENUMRES		OCLRES	OEI	EI	ONAMERES	ONAMECLRES	OVALBOOL	ORES
Вес груза	 	0,5	 	 	 	 	5,,0	т	 	 	 	1,,0
Объем груза	 	1	 	 	 	 	16,,0	MTQ	 	 	 	1,,0
Требуемый класс авто	 	 	 	 	 	122,,0	 	 	Закрытый автотранспорт	Грузовой автотранспорт	 	1,,0
Вариант расчета стоимости	 	 	 	11,,0	 	 	 	 	безналичный с НДС 18%>	 	 	1,,0
Планируемое время (ч)	 	6	 	 	 	 	14,,0	ч	 	 	 	1,,0
Пробег по городу (км)	 	105	 	 	 	 	18,,0	км	 	 	 	1,,0
Пробег по области (км)	 	200	 	 	 	 	18,,0	км	 	 	 	1,,0
Стоимость перевозки	 	61160	 	 	 	 	17,,0	р	 	 	 	1,,0
Стоимость по времени	 	660	 	 	 	 	17,,0	р	 	 	 	1,,0
Стоимость по городу	 	10500	 	 	 	 	17,,0	р	 	 	 	1,,0
Стоимость по области	 	50000	 	 	 	 	17,,0	р	 	 	 	1,,0
Стоимость перевозки по городу	 	1000	 	 	 	 	18,,0	км	 	 	 	1,,0
Стоимость перевозки по области	 	2000	 	 	 	 	18,,0	км	 	 	 	1,,0
Стоимость перевозки по времени	 	3000	 	 	 	 	18,,0	км	 	 	 	1,,0
Общая стоимость перевозки	 	6000	 	 	 	 	18,,0	км	 	 	 	1,,0
2)	102. Тариф  на перевозку 001 класса  131. Тариф на перевозку
ONAMEROLE		OVALREAL			O	OCLRES	OEI	OS	ONAMERES	ON	OVALBOOL	ORES
Вес 1	 	1,00	 	 	 	 	5	т	 	 	 	1
Класс авто 1	 	 	 	 	 	122	 	 	Закрытый автотранспорт	Грузовой автотранспорт	 	1
Класс авто 2	 	 	 	 	 	123	 	 	Открытый автотранспорт	Грузовой автотранспорт	 	1
Класс авто 3	 	 	 	 	 	 	 	 	 	 	 	0
Вес 2	 	2,00	 	 	 	 	5	т	 	 	 	1
Вес 3	 	4,00	 	 	 	 	5	т	 	 	 	1
Объем груза 1	 	1,00	 	 	 	 	16	MTQ	 	 	 	1
Объем груза 2	 	 	 	 	 	 	 	 	 	 	 	0
Объем груза 3	 	 	 	 	 	 	 	 	 	 	 	0
Константа по времени 1 (ч)	 	4,00	 	 	 	 	14	ч	 	 	 	1
Константа по времени 2 (ч)	 	8,00	 	 	 	 	14	ч	 	 	 	1
Расценка по времени 1.1 (р/ч)	 	80,00	 	 	 	 	20	р/ч	 	 	 	1
Расценка по времени 1.2 (р/ч)	 	110,00	 	 	 	 	20	р/ч	 	 	 	1
Расценка по времени 2.1 (р/ч)	 	180,00	 	 	 	 	20	р/ч	 	 	 	1
Расценка по времени 2.2 (р/ч)	 	200,00	 	 	 	 	20	р/ч	 	 	 	1
Расценка по городу 1 (р/км)	 	100,00	 	 	 	 	19	р/км	 	 	 	1
Расценка по городу 2 (р/км)	 	150,00	 	 	 	 	19	р/км	 	 	 	1
Расценка по городу 3 (р/км)	 	200,00	 	 	 	 	19	р/км	 	 	 	1
Расценка по области 1 (р/км)	 	250,00	 	 	 	 	19	р/км	 	 	 	1
Расценка по области 3 (р/км)	 	 	 	 	 	 	 	 	 	 	 	0
Расценка по городу 0 (р/км)	 	 	 	 	 	 	 	 	 	 	 	0
Расценка по области 0 (р/км)	 	 	 	 	 	 	 	 	 	 	 	0
Расценка по времени 0(р/ч)	 	 	 	 	 	 	 	 	 	 	 	0
Расценка по области 2 (р/км)	 	300,00	 	 	 	 	19	р/км	 	 	 	1
И ПрГр1диап	 	 	 	 	 	 	 	 	 	 	 	0
Выбранная Расценка по времени (р/ч)	 	 	 	 	 	 	 	 	 	 	 	0
Выбранная Расценка по области  (р/км)	 	 	 	 	 	 	 	 	 	 	 	0
Выбранная Расценка по городу(р/км)	 	 	 	 	 	 	 	 	 	 	 	0
По классу авто 1	 	 	 	 	 	 	 	 	 	 	1	0
По классу авто 2	 	 	 	 	 	 	 	 	 	 	 	0
По классу авто 3	 	 	 	 	 	 	 	 	 	 	 	0
По весу 1	 	 	 	 	 	 	 	 	 	 	1	0
По весу 2	 	 	 	 	 	 	 	 	 	 	0	0
По весу 1.3	 	 	 	 	 	 	 	 	 	 	1	0
По весу 1.4	 	 	 	 	 	 	 	 	 	 	 	0
По весу 1.5	 	 	 	 	 	 	 	 	 	 	 	0
По объему 1.1	 	 	 	 	 	 	 	 	 	 	 	0
По объему 1.2	 	 	 	 	 	 	 	 	 	 	 	0
По объему 1.3	 	 	 	 	 	 	 	 	 	 	 	0
По объему 1.4	 	 	 	 	 	 	 	 	 	 	 	0
По объему 1.5	 	 	 	 	 	 	 	 	 	 	 	0
По времени 1.1 (ч)	 	 	 	 	 	 	 	 	 	 	 	0
По времени 1.2 (ч)	 	 	 	 	 	 	 	 	 	 	 	0
По времени 1.3 (ч)	 	 	 	 	 	 	 	 	 	 	 	0
ИЛИ ЛевГр2диап	 	 	 	 	 	 	 	 	 	 	 	0
И ПрГр2диап	 	 	 	 	 	 	 	 	 	 	 	0
И 2 диапазон	 	 	 	 	 	 	 	 	 	 	 	0
И ЛевГр3диап	 	 	 	 	 	 	 	 	 	 	 	0
 3 диап.GV	 	 	 	 	 	 	 	 	 	 	 	0
ИЛИ Лев. граница 2 диапазона Т	 	 	 	 	 	 	 	 	 	 	 	0
И 2 диапазон времени Т	 	 	 	 	 	 	 	 	 	 	 	0
Правило GV 2	 	 	 	 	 	 	 	 	 	 	 	0
Правило GV 3	 	 	 	 	 	 	 	 	 	 	 	0
Пр. граница 3 диап.	 	 	 	 	 	 	 	 	 	 	 	0
Правило Т1	 	 	 	 	 	 	 	 	 	 	 	0
Правило Т1.2	 	 	 	 	 	 	 	 	 	 	 	0
Правило Т2.1	 	 	 	 	 	 	 	 	 	 	 	0
Правило Т2.2	 	 	 	 	 	 	 	 	 	 	 	0
Правило по классу авто 1	 	 	 	 	 	 	 	 	 	 	 	0
Правило по классу авто 2	 	 	 	 	 	 	 	 	 	 	 	0
Правило по классу авто 3	 	 	 	 	 	 	 	 	 	 	 	0
Правило GV 1	 	 	 	 	 	 	 	 	 	 	 	0
 
Рис. *.*. Диаграмма кооперации для фрагмента примера работы с тарифами на перевозку
Выводы
1.	Разработан проект каркаса для работы с заказами на услуги на основе правил и ограничений, содержащий конструктор и исполнитель расчетов на основе правил и ограничений. 
2.	Разработаны фрагменты реализации каркаса в среде реляционной СУБД.
3. Выполнено тестирование основных функций работы с заказами на услуги: 
	Ведение классификатора услуг и правил их заказа;
	Формирование шаблонов заказов на услуги;
	Формирование экземпляров заказов на услуги по шаблонам;
	Расчеты стоимости заказанных услуг.
4.Результаты тестирования подтвердили работоспособность предложенных решений.

