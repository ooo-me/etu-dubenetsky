# Core Library Tests

Полноценные unit тесты для библиотеки ядра (`core`), которые реализуют пользовательские сценарии GUI-приложения без использования самого GUI.

## Описание

Тесты проверяют функционал работы с тарифами на услуги, включая:
- Единицы измерения
- Типы услуг и их параметры
- Исполнителей (транспортные компании, склады)
- Тарифы и ставки
- Заказы
- **Поиск оптимального исполнителя** (ключевой функционал)
- Расчёт стоимости заказа
- Интеграционные сценарии

## Структура тестов

```
src/core_tests/
├── CMakeLists.txt              # Конфигурация сборки тестов
├── TestFixture.h               # Базовый fixture с подготовкой данных
├── UnitTests.cpp               # Тесты единиц измерения
├── ServiceTypeTests.cpp        # Тесты типов услуг
├── ExecutorTests.cpp           # Тесты исполнителей
├── TariffTests.cpp             # Тесты тарифов и ставок
├── OrderTests.cpp              # Тесты заказов
├── OptimalExecutorTests.cpp    # Тесты поиска оптимального исполнителя ⭐
├── CalculationTests.cpp        # Тесты расчёта стоимости
└── IntegrationTests.cpp        # Интеграционные тесты
```

## Ключевые тестовые сценарии

### 1. Выбор перевозчика для лёгкого груза
Создаётся несколько транспортных компаний с разными тарифами. Система выбирает самого дешёвого перевозчика для заказа на перевозку 0.5т груза на 4 часа.

### 2. Выбор перевозчика для тяжёлого груза
Перевозка 5т груза с учётом времени аренды и перепробега (100км по городу + 50км по области). Система учитывает все составляющие стоимости.

### 3. Выбор склада для ответственного хранения
Поиск оптимального склада для хранения 100 паллет на 30 дней среди нескольких складских операторов.

### 4. Фильтрация по дате действия тарифа
Проверка, что при поиске на конкретную дату возвращаются только действующие тарифы (истёкшие и будущие не включаются).

### 5. Учёт НДС
Сравнение стоимости с НДС (18%, 20%) и без НДС. Проверка корректности расчётов.

## Требования

- PostgreSQL 15 на порту **5433** с базой данных **`tariff_test`**
- Пользователь: `postgres`, пароль: `postgres`
- GTest 1.15.0
- CMake 3.16+
- C++20 компилятор

## Сборка и запуск

### Сборка с тестами

```bash
# Из корня проекта
mkdir build
cd build

# Конфигурация с включением тестов
cmake .. -DBUILD_TESTING=ON

# Сборка
cmake --build .

# Запуск тестов
./src/core_tests/core_tests

# Или через CTest
ctest --test-dir . --output-on-failure
```

### Запуск конкретных тестов

```bash
# Запуск только тестов оптимального исполнителя
./src/core_tests/core_tests --gtest_filter="OptimalExecutorTest.*"

# Запуск конкретного теста
./src/core_tests/core_tests --gtest_filter="OptimalExecutorTest.FindCheapestTransportForLightCargo"

# Подробный вывод
./src/core_tests/core_tests --gtest_filter="OptimalExecutorTest.*" --gtest_print_time
```

## Подготовка тестовой базы данных

Перед запуском тестов необходимо:

1. Убедиться, что PostgreSQL 15 запущен на порту 5433
2. Создать базу данных `tariff_test`:

```sql
CREATE DATABASE tariff_test;
```

**Важно:** Каждый тест автоматически пересоздаёт схему БД для обеспечения изоляции тестов.

## Тестовые данные

Тесты используют реальные данные из файла `docs/data.txt`:

### Тарифы на грузоперевозки (закрытые авто, НДС 18%)

| Грузоподъёмность | Тариф 4ч | Стоимость часа | Руб/км город | Руб/км область |
|------------------|----------|----------------|--------------|----------------|
| 0.5 т            | 1900     | 420            | 14           | 16             |
| 1 т              | 2120     | 470            | 15           | 17             |
| 1.5 т (до 10м³)  | 2220     | 495            | 16           | 18             |
| 2 т              | 2480     | 550            | 17           | 19             |
| 5 т (20-30м³)    | 6280     | 785            | 23           | 25             |

### Ответственное хранение

| Услуга                          | Ед. изм.  | Стоимость с НДС |
|---------------------------------|-----------|-----------------|
| Хранение паллет                 | руб/сутки | 8.00-16.00      |
| Приёмка механизированная        | 1 паллет  | 50.00-100.00    |
| Обмотка стрейч-пленкой          | 1 паллет  | 50.00-80.00     |

## Архитектура тестов

### TestFixture

Базовый класс `TariffServiceTestFixture` предоставляет:
- Автоматическое подключение к тестовой БД
- Инициализацию схемы для каждого теста
- Вспомогательные методы для создания тестовых данных:
  - `CreateTestUnit()` - единица измерения
  - `CreateTestServiceType()` - тип услуги
  - `CreateTestExecutor()` - исполнитель
  - `CreateTestTariff()` - тариф
  - `CreateTestOrder()` - заказ

### Принципы

1. **Изоляция**: каждый тест работает с чистой БД
2. **Реалистичность**: используются реальные тарифы из задания
3. **Полнота**: покрытие всех основных сценариев
4. **Понятность**: комментарии на русском языке

## Проверка покрытия

Тесты покрывают:
- ✅ CRUD операции для всех сущностей
- ✅ Поиск оптимального исполнителя по стоимости
- ✅ Расчёт стоимости заказа
- ✅ Валидация данных заказа
- ✅ Фильтрация по дате действия тарифа
- ✅ Учёт НДС в расчётах
- ✅ Полные сценарии работы с заказами

## Примеры использования

### Пример теста поиска оптимального исполнителя

```cpp
TEST_F(OptimalExecutorTest, FindCheapestTransportForLightCargo)
{
    // 1. Создание типа услуги "Грузоперевозка"
    auto serviceType = CreateTransportServiceType();
    
    // 2. Создание исполнителей с разными тарифами
    auto executor1 = CreateTestExecutor("TC_FAST", "ТК Быстрый", true);
    auto executor2 = CreateTestExecutor("TC_ECON", "ТК Экономный", true);
    
    auto tariff1 = CreateTestTariff(serviceType.id, executor1.id, ...);
    CreateTestTariffRate(tariff1.id, "HOUR_RATE", ..., 500.0, ...);
    
    auto tariff2 = CreateTestTariff(serviceType.id, executor2.id, ...);
    CreateTestTariffRate(tariff2.id, "HOUR_RATE", ..., 420.0, ...); // Дешевле
    
    // 3. Поиск оптимального
    auto results = service_->FindOptimalExecutor(serviceType.id, "2025-01-15");
    
    // 4. Проверки
    ASSERT_FALSE(results.empty());
    EXPECT_EQ(results[0].executorName, "ТК Экономный");
    EXPECT_LT(results[0].estimatedCost, results[1].estimatedCost);
}
```

## Troubleshooting

### Тесты не запускаются

1. Проверьте, что PostgreSQL 15 запущен:
   ```bash
   pg_isready -h localhost -p 5433
   ```

2. Проверьте подключение к БД:
   ```bash
   psql -h localhost -p 5433 -U postgres -d tariff_test
   ```

3. Убедитесь, что база `tariff_test` создана

### Тесты падают с ошибками БД

Проверьте, что:
- Схема БД создаётся корректно (в TestFixture вызывается InitializeDatabase)
- У пользователя postgres есть права на создание объектов
- Порт 5433 не занят другим процессом

### Тесты пропускаются (SKIPPED)

Если тесты пропускаются с сообщением "Не удалось подключиться к тестовой БД", проверьте:
- PostgreSQL запущен на порту 5433
- База данных tariff_test существует
- Пользователь postgres с паролем postgres имеет доступ

## Вклад в развитие

При добавлении новых тестов:
1. Наследуйтесь от `TariffServiceTestFixture`
2. Используйте вспомогательные методы для создания данных
3. Добавляйте комментарии на русском языке
4. Следуйте структуре: Подготовка -> Выполнение -> Проверка
5. Обновляйте этот README при добавлении новых сценариев
